{"version":3,"sources":["../../../src/journals/guards/auth-journal.guard.ts"],"sourcesContent":["import { CanActivate, ExecutionContext, ForbiddenException, Injectable } from '@nestjs/common';\n\nimport { WinstonLoggerService } from '../../common/logger/winstonLogger.service';\nimport { JournalsService } from '../journals.service';\n\n@Injectable()\nexport class AuthJournalGuard implements CanActivate {\n    constructor(\n        private readonly journalsService: JournalsService,\n        private readonly logger: WinstonLoggerService,\n    ) {}\n\n    async canActivate(context: ExecutionContext): Promise<boolean> {\n        const request = context.switchToHttp().getRequest();\n        const { userId } = request.user;\n        const journalId = parseInt(request.params.id);\n\n        await this.checkJournalOwnership(userId, journalId);\n\n        return true;\n    }\n\n    private async checkJournalOwnership(userId: number, journalId: number): Promise<void> {\n        const [owned] = await this.journalsService.checkJournalOwnership(userId, journalId);\n\n        if (!owned) {\n            const error = new ForbiddenException(\n                `유저 ${userId}은/는 산책일지 ${journalId}에 대한 접근 권한이 없습니다`,\n            );\n            this.logger.error(`유저 ${userId}은/는 산책일지 ${journalId}에 대한 접근 권한이 없습니다`, {\n                trace: error.stack ?? '스택 없음',\n            });\n            throw error;\n        }\n    }\n}\n"],"names":["AuthJournalGuard","canActivate","context","request","switchToHttp","getRequest","userId","user","journalId","parseInt","params","id","checkJournalOwnership","owned","journalsService","error","ForbiddenException","logger","trace","stack","constructor","Injectable"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";+BAMaA;;;eAAAA;;;wBANiE;sCAEzC;iCACL;;;;;;;;;;AAGzB,IAAA,AAAMA,mBAAN,MAAMA;IAMT,MAAMC,YAAYC,OAAyB,EAAoB;QAC3D,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QACjD,MAAM,EAAEC,MAAM,EAAE,GAAGH,QAAQI,IAAI;QAC/B,MAAMC,YAAYC,SAASN,QAAQO,MAAM,CAACC,EAAE;QAE5C,MAAM,IAAI,CAACC,qBAAqB,CAACN,QAAQE;QAEzC,OAAO;IACX;IAEA,MAAcI,sBAAsBN,MAAc,EAAEE,SAAiB,EAAiB;QAClF,MAAM,CAACK,MAAM,GAAG,MAAM,IAAI,CAACC,eAAe,CAACF,qBAAqB,CAACN,QAAQE;QAEzE,IAAI,CAACK,OAAO;YACR,MAAME,QAAQ,IAAIC,0BAAkB,CAChC,CAAC,GAAG,EAAEV,OAAO,SAAS,EAAEE,UAAU,gBAAgB,CAAC;gBAG5CO;YADX,IAAI,CAACE,MAAM,CAACF,KAAK,CAAC,CAAC,GAAG,EAAET,OAAO,SAAS,EAAEE,UAAU,gBAAgB,CAAC,EAAE;gBACnEU,OAAOH,CAAAA,eAAAA,MAAMI,KAAK,cAAXJ,0BAAAA,eAAe;YAC1B;YACA,MAAMA;QACV;IACJ;IA3BAK,YACI,AAAiBN,eAAgC,EACjD,AAAiBG,MAA4B,CAC/C;aAFmBH,kBAAAA;aACAG,SAAAA;IAClB;AAyBP;AA7BajB;IADZqB,IAAAA,kBAAU;;;eAG+B,gCAAe,4BAAf,gCAAe;eACxB,0CAAoB,4BAApB,0CAAoB;;GAHxCrB"}